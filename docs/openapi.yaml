openapi: 3.0.3
info:
  title: Trackable Ingress API
  description: |
    Personal shopping assistant API for post-purchase order management.

    This API provides conversational AI capabilities for managing online shopping orders,
    tracking shipments, understanding merchant policies, and monitoring return/exchange deadlines.

    **Authentication:** This is an internal Cloud Run service requiring GCP IAM authentication.
    Include an identity token in the Authorization header: `Bearer <token>`

    **Model:** Powered by Gemini 2.5 Flash via Google ADK
  version: 0.1.0
  contact:
    name: Trackable Team
  license:
    name: Proprietary

security:
  - BearerAuth: []

tags:
  - name: system
    description: System health and information endpoints
  - name: chat
    description: OpenAI-compatible chat completions API
  - name: orders
    description: Order management endpoints (requires X-User-ID header)
  - name: ingest
    description: Manual email and image submission endpoints (requires X-User-ID header)
  - name: pubsub
    description: Pub/Sub push endpoints for Gmail notifications and policy refresh jobs

paths:
  /:
    get:
      tags:
        - system
      summary: Get service information
      description: Returns basic information about the API service
      operationId: getServiceInfo
      responses:
        "200":
          description: Service information
          content:
            application/json:
              schema:
                type: object
                properties:
                  service:
                    type: string
                    example: Trackable Ingress API
                  version:
                    type: string
                    example: 0.1.0
                  status:
                    type: string
                    example: operational
                  description:
                    type: string
                    example: Personal shopping assistant for post-purchase management

  /health:
    get:
      tags:
        - system
      summary: Health check
      description: Check service health status (used by Cloud Run monitoring)
      operationId: healthCheck
      responses:
        "200":
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  service:
                    type: string
                    example: trackable-ingress
                  environment:
                    type: string
                    example: gen-lang-client-0659747538

  /pubsub/gmail:
    post:
      tags:
        - pubsub
      summary: Handle Gmail Pub/Sub notification
      description: |
        Receive Gmail Pub/Sub push notifications when new emails arrive.

        Decodes the notification payload, resolves the user by Gmail address,
        and enqueues a Gmail sync Cloud Task.
      operationId: handleGmailNotification
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PubSubPushMessage"
            example:
              message:
                data: "eyJlbWFpbEFkZHJlc3MiOiAidXNlckBleGFtcGxlLmNvbSIsICJoaXN0b3J5SWQiOiAiMTIzNDU2In0="
                messageId: "2070443601311540"
                publishTime: "2024-01-26T19:27:01.000Z"
                attributes: {}
              subscription: "projects/my-project/subscriptions/gmail-notifications"
      responses:
        "200":
          description: Notification processed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PubSubResponse"
        "400":
          description: Invalid Pub/Sub payload
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Failed to create Gmail sync task
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /pubsub/policy:
    post:
      tags:
        - pubsub
      summary: Handle policy refresh Pub/Sub trigger
      description: |
        Receive Pub/Sub triggers from Cloud Scheduler to refresh merchant policies.

        Creates policy refresh Cloud Tasks for merchants that need updates.
      operationId: handlePolicyRefresh
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/PubSubPushMessage"
            example:
              message:
                data: "eyJyZWZyZXNoX2FsbCI6IHRydWUsICJtZXJjaGFudF9pZHMiOltdfQ=="
                messageId: "2070443601311541"
                publishTime: "2024-01-26T19:27:01.000Z"
                attributes: {}
              subscription: "projects/my-project/subscriptions/policy-refresh"
      responses:
        "200":
          description: Trigger processed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PubSubResponse"
        "500":
          description: Failed to create policy refresh tasks
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/chat/completions:
    post:
      tags:
        - chat
      summary: Create chat completion (OpenAI-compatible)
      description: |
        Create a chat completion following the OpenAI API format.

        This endpoint provides conversational AI capabilities using Google ADK and Gemini 2.5 Flash,
        wrapped in an OpenAI-compatible interface for easy integration with existing tools.

        **Streaming:**
        Set `stream: true` to receive Server-Sent Events (SSE) with incremental responses.

        **Session Management:**
        Sessions are managed per-user via the `user` field. Include the same `user` value
        in subsequent requests to maintain conversation context.
      operationId: createChatCompletion
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/ChatCompletionRequest"
            examples:
              basic:
                summary: Basic chat request
                value:
                  model: "gemini-2.5-flash"
                  messages:
                    - role: "user"
                      content: "Hello! What is Trackable?"
                  user: "user_12345"
              withSystem:
                summary: With system message
                value:
                  model: "gemini-2.5-flash"
                  messages:
                    - role: "system"
                      content: "You are a helpful shopping assistant."
                    - role: "user"
                      content: "What can you help me with?"
                  user: "user_12345"
              streaming:
                summary: Streaming request
                value:
                  model: "gemini-2.5-flash"
                  messages:
                    - role: "user"
                      content: "Tell me about order tracking"
                  stream: true
                  user: "user_12345"
      responses:
        "200":
          description: Successful completion (non-streaming)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ChatCompletionResponse"
              example:
                id: "chatcmpl-abc123def456"
                object: "chat.completion"
                created: 1706300000
                model: "gemini-2.5-flash"
                choices:
                  - index: 0
                    message:
                      role: "assistant"
                      content: "Hello! I'm Trackable, your personal shopping assistant."
                    finish_reason: "stop"
                usage:
                  prompt_tokens: 10
                  completion_tokens: 15
                  total_tokens: 25
            text/event-stream:
              schema:
                type: string
                description: |
                  SSE stream of chat completion chunks (when stream=true).

                  Each chunk follows the format:
                  ```
                  data: {"id":"chatcmpl-...","choices":[{"delta":{"content":"..."}}]}
                  ```

                  Stream ends with:
                  ```
                  data: [DONE]
                  ```
              examples:
                streamResponse:
                  summary: Streaming response
                  value: |
                    data: {"id":"chatcmpl-abc123","object":"chat.completion.chunk","created":1706300000,"model":"gemini-2.5-flash","choices":[{"index":0,"delta":{"role":"assistant"},"finish_reason":null}]}

                    data: {"id":"chatcmpl-abc123","object":"chat.completion.chunk","created":1706300000,"model":"gemini-2.5-flash","choices":[{"index":0,"delta":{"content":"Hello!"},"finish_reason":null}]}

                    data: {"id":"chatcmpl-abc123","object":"chat.completion.chunk","created":1706300000,"model":"gemini-2.5-flash","choices":[{"index":0,"delta":{"content":" I'm Trackable."},"finish_reason":null}]}

                    data: {"id":"chatcmpl-abc123","object":"chat.completion.chunk","created":1706300000,"model":"gemini-2.5-flash","choices":[{"index":0,"delta":{},"finish_reason":"stop"}]}

                    data: [DONE]
          headers:
            Cache-Control:
              schema:
                type: string
                example: no-cache
            Connection:
              schema:
                type: string
                example: keep-alive
            X-Accel-Buffering:
              schema:
                type: string
                example: "no"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                detail: "messages: field required"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                detail: "Chat completion failed: Internal error"

  /api/v1/chat/sessions:
    delete:
      tags:
        - chat
      summary: Clear chat session
      description: |
        Clear the chat session for a user, resetting conversation history.

        After clearing, the next chat request from the user will automatically
        create a fresh session with no prior context.
      operationId: clearChatSession
      parameters:
        - name: user
          in: query
          description: User identifier (defaults to "default_user")
          required: false
          schema:
            type: string
            default: "default_user"
            example: "user_12345"
      responses:
        "200":
          description: Session cleared or not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ClearSessionResponse"
              examples:
                cleared:
                  summary: Session cleared
                  value:
                    message: "Session cleared"
                    user: "user_12345"
                notFound:
                  summary: No session found
                  value:
                    message: "No session found"
                    user: "user_12345"

  /api/v1/orders:
    get:
      tags:
        - orders
      summary: List orders
      description: |
        Retrieve a paginated list of orders for the authenticated user.

        Orders are returned sorted by creation date (newest first).
      operationId: listOrders
      security:
        - UserIdAuth: []
      parameters:
        - name: status
          in: query
          description: Filter by order status
          required: false
          schema:
            $ref: "#/components/schemas/OrderStatus"
        - name: limit
          in: query
          description: Maximum number of orders to return (1-500)
          required: false
          schema:
            type: integer
            minimum: 1
            maximum: 500
            default: 100
        - name: offset
          in: query
          description: Number of orders to skip for pagination
          required: false
          schema:
            type: integer
            minimum: 0
            default: 0
      responses:
        "200":
          description: List of orders
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/OrderListResponse"
        "400":
          description: Invalid request parameters
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing X-User-ID header
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Database unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/orders/{order_id}:
    get:
      tags:
        - orders
      summary: Get order details
      description: Retrieve details of a specific order by ID.
      operationId: getOrder
      security:
        - UserIdAuth: []
      parameters:
        - name: order_id
          in: path
          description: Order ID (UUID)
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Order details
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "401":
          description: Missing X-User-ID header
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Order belongs to different user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Order not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Database unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    patch:
      tags:
        - orders
      summary: Update order
      description: |
        Update specific fields of an order.

        Only the fields provided in the request body will be updated.
        Notes are appended to the existing notes list.
      operationId: updateOrder
      security:
        - UserIdAuth: []
      parameters:
        - name: order_id
          in: path
          description: Order ID (UUID)
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/OrderUpdateRequest"
      responses:
        "200":
          description: Updated order
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Order"
        "400":
          description: Invalid request body
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "401":
          description: Missing X-User-ID header
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Order belongs to different user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Order not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Database unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

    delete:
      tags:
        - orders
      summary: Delete order
      description: Permanently delete an order and all associated data.
      operationId: deleteOrder
      security:
        - UserIdAuth: []
      parameters:
        - name: order_id
          in: path
          description: Order ID (UUID)
          required: true
          schema:
            type: string
            format: uuid
      responses:
        "200":
          description: Order deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: "Order 550e8400-e29b-41d4-a716-446655440000 deleted successfully"
        "401":
          description: Missing X-User-ID header
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "403":
          description: Order belongs to different user
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "404":
          description: Order not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Database unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/ingest/email:
    post:
      tags:
        - ingest
      summary: Submit email for order extraction
      description: |
        Submit an email for order extraction. Creates a job that is processed
        asynchronously by the Worker service via Cloud Tasks.

        The email content will be parsed by the input processor agent to extract
        order information including merchant, items, prices, and tracking details.
      operationId: ingestEmail
      security:
        - UserIdAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestEmailRequest"
            examples:
              basic:
                summary: Basic email submission
                value:
                  email_content: "From: orders@amazon.com\nSubject: Your order has shipped\n\nOrder #123-456 has shipped..."
              withMetadata:
                summary: With metadata
                value:
                  email_content: "Order confirmation from Nike..."
                  email_subject: "Your Nike order confirmation"
                  email_from: "orders@nike.com"
      responses:
        "200":
          description: Email submitted for processing
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestResponse"
              example:
                job_id: "550e8400-e29b-41d4-a716-446655440000"
                source_id: "660e8400-e29b-41d4-a716-446655440001"
                status: "queued"
                message: "Email submitted for processing. Use the job_id to check status."
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/ingest/image:
    post:
      tags:
        - ingest
      summary: Submit screenshot for order extraction
      description: |
        Submit a screenshot for order extraction. Creates a job that is processed
        asynchronously by the Worker service via Cloud Tasks.

        The image will be analyzed by the input processor agent (with vision capability)
        to extract order information. Duplicate images are detected via SHA-256 hash.
      operationId: ingestImage
      security:
        - UserIdAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestImageRequest"
            examples:
              basic:
                summary: Basic image submission
                value:
                  image_data: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
              withFilename:
                summary: With filename
                value:
                  image_data: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk+M9QDwADhgGAWjR9awAAAABJRU5ErkJggg=="
                  filename: "amazon_order.png"
      responses:
        "200":
          description: Image submitted for processing (or duplicate detected)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestResponse"
              examples:
                queued:
                  summary: Image queued for processing
                  value:
                    job_id: "550e8400-e29b-41d4-a716-446655440000"
                    source_id: "660e8400-e29b-41d4-a716-446655440001"
                    status: "queued"
                    message: "Image submitted for processing. Use the job_id to check status."
                duplicate:
                  summary: Duplicate image detected
                  value:
                    job_id: ""
                    source_id: "770e8400-e29b-41d4-a716-446655440002"
                    status: "duplicate"
                    message: "Duplicate image detected. Existing order: 880e8400-e29b-41d4-a716-446655440003"
        "400":
          description: Invalid image data
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
              example:
                detail: "Invalid base64 image data: Incorrect padding"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/ingest/email/batch:
    post:
      tags:
        - ingest
      summary: Submit multiple emails for order extraction
      description: |
        Submit a batch of emails for order extraction. Each email creates a separate job
        that is processed asynchronously by the Worker service via Cloud Tasks.

        Maximum of 50 emails per batch request. Each item is processed independently;
        failures in one item don't affect others.
      operationId: ingestEmailBatch
      security:
        - UserIdAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestBatchEmailRequest"
            example:
              items:
                - email_content: "From: orders@amazon.com\nSubject: Your order\n\nOrder #123..."
                  email_subject: "Your order"
                  email_from: "orders@amazon.com"
                - email_content: "From: orders@nike.com\nSubject: Shipping\n\nTracking #456..."
      responses:
        "200":
          description: Batch processed (check individual results for status)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestBatchResponse"
              example:
                total: 2
                succeeded: 2
                duplicates: 0
                failed: 0
                results:
                  - index: 0
                    status: "success"
                    job_id: "550e8400-e29b-41d4-a716-446655440000"
                    source_id: "660e8400-e29b-41d4-a716-446655440001"
                  - index: 1
                    status: "success"
                    job_id: "550e8400-e29b-41d4-a716-446655440002"
                    source_id: "660e8400-e29b-41d4-a716-446655440003"
        "401":
          description: Missing X-User-ID header
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Database unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

  /api/v1/ingest/image/batch:
    post:
      tags:
        - ingest
      summary: Submit multiple screenshots for order extraction
      description: |
        Submit a batch of screenshots for order extraction. Each image creates a separate job
        that is processed asynchronously by the Worker service via Cloud Tasks.

        Maximum of 50 images per batch request. Duplicate images (detected via SHA-256 hash)
        are skipped and reported in results. Each item is processed independently.
      operationId: ingestImageBatch
      security:
        - UserIdAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/IngestBatchImageRequest"
            example:
              items:
                - image_data: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk..."
                  filename: "order1.png"
                - image_data: "iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNk..."
                  filename: "order2.png"
      responses:
        "200":
          description: Batch processed (check individual results for status)
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/IngestBatchResponse"
              example:
                total: 2
                succeeded: 1
                duplicates: 1
                failed: 0
                results:
                  - index: 0
                    status: "success"
                    job_id: "550e8400-e29b-41d4-a716-446655440000"
                    source_id: "660e8400-e29b-41d4-a716-446655440001"
                  - index: 1
                    status: "duplicate"
                    source_id: "770e8400-e29b-41d4-a716-446655440002"
                    message: "Duplicate image detected"
        "401":
          description: Missing X-User-ID header
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "422":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "500":
          description: Server error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"
        "503":
          description: Database unavailable
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorResponse"

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        GCP Identity Token for authentication.

        To obtain a token:
        ```bash
        TOKEN=$(gcloud auth print-identity-token)
        ```

        Then include in requests:
        ```
        Authorization: Bearer <token>
        ```

    UserIdAuth:
      type: apiKey
      in: header
      name: X-User-ID
      description: |
        User identifier (UUID format) for user-scoped operations.

        Required for orders and ingest endpoints. If the user doesn't exist,
        it will be auto-created in the database.

        Example:
        ```
        X-User-ID: 550e8400-e29b-41d4-a716-446655440000
        ```

  schemas:
    # OpenAI-compatible Chat Completion schemas
    ChatCompletionRequest:
      type: object
      required:
        - messages
      properties:
        model:
          type: string
          description: Model to use (ignored, uses configured agent model)
          default: "gemini-2.5-flash"
          example: "gemini-2.5-flash"
        messages:
          type: array
          description: List of messages in the conversation
          minItems: 1
          items:
            $ref: "#/components/schemas/ChatMessage"
        stream:
          type: boolean
          description: Whether to stream the response
          default: false
        temperature:
          type: number
          description: Sampling temperature (0-2)
          minimum: 0
          maximum: 2
          nullable: true
        max_tokens:
          type: integer
          description: Maximum tokens to generate
          nullable: true
        user:
          type: string
          description: User identifier for session management
          nullable: true
          example: "user_12345"

    ChatMessage:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [system, user, assistant]
          description: The role of the message author
          example: "user"
        content:
          type: string
          description: The content of the message
          example: "Hello! What is Trackable?"

    ChatCompletionResponse:
      type: object
      required:
        - id
        - object
        - created
        - model
        - choices
      properties:
        id:
          type: string
          description: Unique identifier for this completion
          example: "chatcmpl-abc123def456"
        object:
          type: string
          enum: [chat.completion]
          example: "chat.completion"
        created:
          type: integer
          description: Unix timestamp of when the completion was created
          example: 1706300000
        model:
          type: string
          description: Model used for completion
          example: "gemini-2.5-flash"
        choices:
          type: array
          items:
            $ref: "#/components/schemas/ChatCompletionChoice"
        usage:
          $ref: "#/components/schemas/ChatCompletionUsage"

    ChatCompletionChoice:
      type: object
      required:
        - index
        - message
        - finish_reason
      properties:
        index:
          type: integer
          example: 0
        message:
          $ref: "#/components/schemas/ChatCompletionMessage"
        finish_reason:
          type: string
          enum: [stop, length, content_filter]
          nullable: true
          example: "stop"

    ChatCompletionMessage:
      type: object
      required:
        - role
        - content
      properties:
        role:
          type: string
          enum: [assistant]
          example: "assistant"
        content:
          type: string
          example: "Hello! I'm Trackable, your personal shopping assistant."

    ChatCompletionUsage:
      type: object
      properties:
        prompt_tokens:
          type: integer
          example: 10
        completion_tokens:
          type: integer
          example: 15
        total_tokens:
          type: integer
          example: 25

    ChatCompletionChunk:
      type: object
      description: Streaming chunk for chat completion
      required:
        - id
        - object
        - created
        - model
        - choices
      properties:
        id:
          type: string
          example: "chatcmpl-abc123def456"
        object:
          type: string
          enum: [chat.completion.chunk]
          example: "chat.completion.chunk"
        created:
          type: integer
          example: 1706300000
        model:
          type: string
          example: "gemini-2.5-flash"
        choices:
          type: array
          items:
            $ref: "#/components/schemas/ChatCompletionChunkChoice"

    ChatCompletionChunkChoice:
      type: object
      properties:
        index:
          type: integer
          example: 0
        delta:
          $ref: "#/components/schemas/ChatCompletionChunkDelta"
        finish_reason:
          type: string
          enum: [stop, length, content_filter]
          nullable: true

    ChatCompletionChunkDelta:
      type: object
      properties:
        role:
          type: string
          enum: [assistant]
          nullable: true
        content:
          type: string
          nullable: true

    # Pub/Sub schemas
    PubSubMessageData:
      type: object
      required:
        - data
        - messageId
      properties:
        attributes:
          type: object
          additionalProperties:
            type: string
          description: Message attributes
        data:
          type: string
          description: Base64-encoded message payload
        messageId:
          type: string
          description: Pub/Sub message ID
        publishTime:
          type: string
          format: date-time
          description: When the message was published

    PubSubPushMessage:
      type: object
      required:
        - message
        - subscription
      properties:
        message:
          $ref: "#/components/schemas/PubSubMessageData"
        subscription:
          type: string
          description: Subscription resource name

    GmailNotificationPayload:
      type: object
      required:
        - emailAddress
        - historyId
      properties:
        emailAddress:
          type: string
          description: User's Gmail address
        historyId:
          type: string
          description: Gmail history ID for incremental sync

    PolicyRefreshPayload:
      type: object
      properties:
        refresh_all:
          type: boolean
          default: true
          description: Whether to refresh all merchants
        merchant_ids:
          type: array
          items:
            type: string
          description: Specific merchant IDs to refresh (if not refresh_all)

    PubSubResponse:
      type: object
      required:
        - status
        - message
        - tasks_created
      properties:
        status:
          type: string
          description: Processing status
        message:
          type: string
          description: Status message
        tasks_created:
          type: integer
          description: Number of Cloud Tasks created
          default: 0
        details:
          type: object
          additionalProperties: true
          description: Additional details

    # Ingest API schemas
    IngestEmailRequest:
      type: object
      required:
        - email_content
      properties:
        email_content:
          type: string
          description: Raw email content (EML format or plain text)
          minLength: 1
          example: "From: orders@amazon.com\nSubject: Your order\n\nOrder confirmed!"
        email_subject:
          type: string
          description: Email subject line (optional)
          nullable: true
          example: "Your order has shipped"
        email_from:
          type: string
          description: Sender email address (optional)
          nullable: true
          example: "orders@amazon.com"

    IngestImageRequest:
      type: object
      required:
        - image_data
      properties:
        image_data:
          type: string
          description: Base64 encoded image data
          minLength: 1
        filename:
          type: string
          description: Original filename (optional)
          nullable: true
          example: "screenshot.png"

    IngestResponse:
      type: object
      required:
        - job_id
        - source_id
        - status
        - message
      properties:
        job_id:
          type: string
          format: uuid
          description: Job ID for tracking processing status
          example: "550e8400-e29b-41d4-a716-446655440000"
        source_id:
          type: string
          format: uuid
          description: Source ID for the submitted content
          example: "660e8400-e29b-41d4-a716-446655440001"
        status:
          type: string
          enum: [queued, duplicate]
          description: Initial status (queued or duplicate if image already processed)
          example: "queued"
        message:
          type: string
          description: Human-readable status message
          example: "Email submitted for processing. Use the job_id to check status."

    # Batch Ingest API schemas
    BatchEmailItem:
      type: object
      required:
        - email_content
      properties:
        email_content:
          type: string
          description: Raw email content (EML format or plain text)
          minLength: 1
        email_subject:
          type: string
          description: Email subject line (optional)
          nullable: true
        email_from:
          type: string
          description: Sender email address (optional)
          nullable: true

    BatchImageItem:
      type: object
      required:
        - image_data
      properties:
        image_data:
          type: string
          description: Base64 encoded image data
          minLength: 1
        filename:
          type: string
          description: Original filename (optional)
          nullable: true

    IngestBatchEmailRequest:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          description: List of emails to ingest (1-50 items)
          minItems: 1
          maxItems: 50
          items:
            $ref: "#/components/schemas/BatchEmailItem"

    IngestBatchImageRequest:
      type: object
      required:
        - items
      properties:
        items:
          type: array
          description: List of images to ingest (1-50 items)
          minItems: 1
          maxItems: 50
          items:
            $ref: "#/components/schemas/BatchImageItem"

    BatchItemStatus:
      type: string
      enum: [success, duplicate, failed]
      description: Status of a single item in a batch operation

    BatchItemResult:
      type: object
      required:
        - index
        - status
      properties:
        index:
          type: integer
          description: Zero-based index of item in the request
          example: 0
        status:
          $ref: "#/components/schemas/BatchItemStatus"
        job_id:
          type: string
          format: uuid
          description: Job ID for tracking (null if failed)
          nullable: true
        source_id:
          type: string
          format: uuid
          description: Source ID for the submitted content (null if failed)
          nullable: true
        error:
          type: string
          description: Error message if status is 'failed'
          nullable: true
        message:
          type: string
          description: Additional info (e.g., for duplicates)
          nullable: true

    IngestBatchResponse:
      type: object
      required:
        - total
        - succeeded
        - duplicates
        - failed
        - results
      properties:
        total:
          type: integer
          description: Total items in request
          example: 3
        succeeded:
          type: integer
          description: Number of items successfully queued
          example: 2
        duplicates:
          type: integer
          description: Number of duplicate items (images only)
          example: 1
        failed:
          type: integer
          description: Number of items that failed
          example: 0
        results:
          type: array
          description: Individual results per item
          items:
            $ref: "#/components/schemas/BatchItemResult"

    # Order API schemas
    OrderStatus:
      type: string
      enum:
        - detected
        - confirmed
        - shipped
        - in_transit
        - delivered
        - returned
        - refunded
        - cancelled
        - unknown
      description: Order lifecycle status

    ShipmentStatus:
      type: string
      enum:
        - pending
        - label_created
        - in_transit
        - out_for_delivery
        - delivered
        - delivery_attempted
        - exception
        - returned_to_sender
        - unknown
      description: Shipment tracking status

    Carrier:
      type: string
      enum:
        - usps
        - ups
        - fedex
        - dhl
        - amazon_logistics
        - other
        - unknown
      description: Shipping carrier

    ItemCondition:
      type: string
      enum:
        - new
        - opened
        - used
        - damaged
        - unknown
      description: Item condition for returns

    SourceType:
      type: string
      enum:
        - email
        - screenshot
        - photo
        - manual
        - api
      description: Source of order information

    Money:
      type: object
      required:
        - amount
      properties:
        amount:
          type: string
          description: Amount as decimal string
          example: "120.00"
        currency:
          type: string
          description: ISO 4217 currency code
          default: "USD"
          example: "USD"

    Merchant:
      type: object
      required:
        - id
        - name
      properties:
        id:
          type: string
          description: Internal merchant identifier
          example: "merch_nike"
        name:
          type: string
          description: Merchant display name
          example: "Nike"
        domain:
          type: string
          description: Merchant domain
          nullable: true
          example: "nike.com"
        support_email:
          type: string
          description: Support email
          nullable: true
          example: "support@nike.com"
        support_url:
          type: string
          format: uri
          description: Support URL
          nullable: true
        return_portal_url:
          type: string
          format: uri
          description: Return portal URL
          nullable: true

    Item:
      type: object
      required:
        - id
        - order_id
        - name
      properties:
        id:
          type: string
          description: Internal item identifier
        order_id:
          type: string
          description: Parent order ID
        name:
          type: string
          description: Item name/title
          example: "Air Max 90"
        description:
          type: string
          description: Item description
          nullable: true
        quantity:
          type: integer
          description: Quantity ordered
          default: 1
          example: 1
        price:
          $ref: "#/components/schemas/Money"
        sku:
          type: string
          description: Stock keeping unit
          nullable: true
        size:
          type: string
          description: Size variant
          nullable: true
          example: "10"
        color:
          type: string
          description: Color variant
          nullable: true
          example: "Black"
        condition:
          $ref: "#/components/schemas/ItemCondition"
        image_url:
          type: string
          format: uri
          description: Product image URL
          nullable: true
        is_returnable:
          type: boolean
          description: Whether item can be returned
          nullable: true
        is_exchangeable:
          type: boolean
          description: Whether item can be exchanged
          nullable: true
        return_requested:
          type: boolean
          description: Return has been requested
          default: false
        exchange_requested:
          type: boolean
          description: Exchange has been requested
          default: false

    TrackingEvent:
      type: object
      required:
        - timestamp
        - status
      properties:
        timestamp:
          type: string
          format: date-time
          description: Event timestamp
        status:
          $ref: "#/components/schemas/ShipmentStatus"
        location:
          type: string
          description: Event location
          nullable: true
        description:
          type: string
          description: Event description
          nullable: true

    Shipment:
      type: object
      required:
        - id
        - order_id
      properties:
        id:
          type: string
          description: Internal shipment identifier
        order_id:
          type: string
          description: Parent order ID
        tracking_number:
          type: string
          description: Carrier tracking number
          nullable: true
        carrier:
          $ref: "#/components/schemas/Carrier"
        status:
          $ref: "#/components/schemas/ShipmentStatus"
        shipping_address:
          type: string
          description: Shipping address
          nullable: true
        return_address:
          type: string
          description: Return address
          nullable: true
        shipped_at:
          type: string
          format: date-time
          description: Ship date
          nullable: true
        estimated_delivery:
          type: string
          format: date-time
          description: Estimated delivery date
          nullable: true
        delivered_at:
          type: string
          format: date-time
          description: Actual delivery date
          nullable: true
        tracking_url:
          type: string
          format: uri
          description: Carrier tracking URL
          nullable: true
        events:
          type: array
          description: Tracking events
          items:
            $ref: "#/components/schemas/TrackingEvent"
        last_updated:
          type: string
          format: date-time
          description: Last tracking update
          nullable: true

    Order:
      type: object
      required:
        - id
        - user_id
        - merchant
        - source_type
      properties:
        id:
          type: string
          format: uuid
          description: Internal order identifier
          example: "ord_abc123"
        user_id:
          type: string
          format: uuid
          description: User who owns this order
        merchant:
          $ref: "#/components/schemas/Merchant"
        order_number:
          type: string
          description: Merchant order number
          nullable: true
          example: "NKE-2024-001234"
        order_date:
          type: string
          format: date-time
          description: Order placement date
          nullable: true
        status:
          $ref: "#/components/schemas/OrderStatus"
        country_code:
          type: string
          description: ISO 3166-1 alpha-2 country code
          nullable: true
          example: "US"
        items:
          type: array
          description: Order items
          items:
            $ref: "#/components/schemas/Item"
        subtotal:
          $ref: "#/components/schemas/Money"
        tax:
          $ref: "#/components/schemas/Money"
        shipping_cost:
          $ref: "#/components/schemas/Money"
        total:
          $ref: "#/components/schemas/Money"
        shipments:
          type: array
          description: Shipment information
          items:
            $ref: "#/components/schemas/Shipment"
        return_window_start:
          type: string
          format: date-time
          description: Return window start (usually delivery date)
          nullable: true
        return_window_end:
          type: string
          format: date-time
          description: Return window end date
          nullable: true
        return_window_days:
          type: integer
          description: Return window duration in days
          nullable: true
        exchange_window_end:
          type: string
          format: date-time
          description: Exchange window end date
          nullable: true
        is_monitored:
          type: boolean
          description: Whether user is actively monitoring this order
          default: true
        source_type:
          $ref: "#/components/schemas/SourceType"
        source_id:
          type: string
          description: Source identifier (email ID, file path, etc.)
          nullable: true
        confidence_score:
          type: number
          format: float
          description: Extraction confidence (0.0-1.0)
          minimum: 0
          maximum: 1
          nullable: true
        needs_clarification:
          type: boolean
          description: Agent needs user clarification
          default: false
        clarification_questions:
          type: array
          description: Questions for user
          items:
            type: string
        order_url:
          type: string
          format: uri
          description: Order details URL
          nullable: true
        receipt_url:
          type: string
          format: uri
          description: Receipt URL
          nullable: true
        refund_initiated:
          type: boolean
          description: Refund has been initiated
          default: false
        refund_amount:
          $ref: "#/components/schemas/Money"
        refund_completed_at:
          type: string
          format: date-time
          description: Refund completion date
          nullable: true
        created_at:
          type: string
          format: date-time
          description: Record creation time
        updated_at:
          type: string
          format: date-time
          description: Last update time
        notes:
          type: array
          description: Agent observations and notes
          items:
            type: string
        last_agent_intervention:
          type: string
          format: date-time
          description: Last time agent intervened
          nullable: true

    OrderListResponse:
      type: object
      required:
        - orders
        - total
        - limit
        - offset
      properties:
        orders:
          type: array
          description: List of orders
          items:
            $ref: "#/components/schemas/Order"
        total:
          type: integer
          description: Total number of orders matching the query
          example: 42
        limit:
          type: integer
          description: Maximum number of orders returned
          example: 100
        offset:
          type: integer
          description: Number of orders skipped
          example: 0

    OrderUpdateRequest:
      type: object
      properties:
        status:
          $ref: "#/components/schemas/OrderStatus"
        note:
          type: string
          description: Note to append to the order
        is_monitored:
          type: boolean
          description: Whether to monitor this order

    ClearSessionResponse:
      type: object
      required:
        - message
        - user
      properties:
        message:
          type: string
          description: Status message indicating whether session was cleared
          example: "Session cleared"
        user:
          type: string
          description: User identifier
          example: "user_12345"

    ErrorResponse:
      type: object
      required:
        - detail
      properties:
        detail:
          type: string
          description: Error message describing what went wrong
          example: "Chat completion failed: Internal error"

  examples:
    BasicChatRequest:
      summary: Basic chat completion request
      value:
        model: "gemini-2.5-flash"
        messages:
          - role: "user"
            content: "Hello! What is Trackable?"
        user: "user_12345"

    StreamingChatRequest:
      summary: Streaming chat completion request
      value:
        model: "gemini-2.5-flash"
        messages:
          - role: "user"
            content: "Tell me about order tracking"
        stream: true
        user: "user_12345"

    ChatCompletionExample:
      summary: Successful chat completion response
      value:
        id: "chatcmpl-abc123def456"
        object: "chat.completion"
        created: 1706300000
        model: "gemini-2.5-flash"
        choices:
          - index: 0
            message:
              role: "assistant"
              content: "Hello! I'm Trackable, your personal shopping assistant."
            finish_reason: "stop"
        usage:
          prompt_tokens: 10
          completion_tokens: 15
          total_tokens: 25
